name: Build and Release Executables

# This workflow runs whenever a new git tag (like v1.0.0) is pushed.
on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  # 1. Consolidated Build Job for All Platforms (Linux, Windows, macOS)
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        
        # Define platform-specific variables for compilation and file naming
        include:
          - os: ubuntu-latest
            asset_name_base: interpreter-linux
            file_extension: '' # Linux executables have no extension
          - os: windows-latest
            asset_name_base: interpreter-win
            file_extension: '.exe' # Windows executables use .exe
          - os: macos-latest
            asset_name_base: interpreter-macos
            file_extension: '' # macOS executables (non-app bundle) have no extension
            
    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python 3.12 (Fixed to use a stable version)
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: üì¶ Install PyInstaller
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: üî® Compile executable with custom name
        # Use the --name flag to set the base name for the executable/bundle
        run: |
          pyinstaller --onefile --name ${{ matrix.asset_name_base }} interpreter.py

      - name: üì§ Upload executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name_base }}
          # The path is constructed from the PyInstaller output folder 'dist'
          # and the full file name, including the matrix-defined extension.
          path: dist/${{ matrix.asset_name_base }}${{ matrix.file_extension }}

  # 2. Create the GitHub Release and attach assets
  create_release:
    name: Create Release and Attach Assets
    # This job waits for all three OS builds to finish
    needs: build
    runs-on: ubuntu-latest
    
    # FIX: Grant write permission for releases/contents to fix the 403 error
    permissions: 
      contents: write 

    steps:
      - name: ‚¨áÔ∏è Checkout code (to get interpreter.py)
        uses: actions/checkout@v4
        
      - name: ‚¨áÔ∏è Download all artifacts
        # Downloads artifacts into this folder structure:
        # release_assets/interpreter-linux/interpreter-linux
        # release_assets/interpreter/interpreter-win.exe
        # release_assets/interpreter-macos/interpreter-macos
        uses: actions/download-artifact@v4
        with:
          path: release_assets 

      - name: üè∑Ô∏è Get the version tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: üìù Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## New Cross-Platform Release
            Automatic build of Linux, Windows, and macOS executables.
          draft: false
          prerelease: false
          # Attach all three executables and the source file
          files: |
            release_assets/interpreter-linux/interpreter-linux
            release_assets/interpreter-win/interpreter-win.exe
            release_assets/interpreter-macos/interpreter-macos
            interpreter.py
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
